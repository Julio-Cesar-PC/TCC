<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Create Python Parsons Puzzles</title>

  <link rel="icon" href="./assets/logoicon.png">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <!-- Tagify CSS -->
  <link href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css" rel="stylesheet" type="text/css" />
  <!-- W3school -->
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css" />
  <!-- Quill -->
  <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet" />

  <link href="./parsons.css" rel="stylesheet" />
  <link href="./lib/prettify.css" rel="stylesheet" />
  <link href="./cssAnimations.css" rel="stylesheet" />
  <link href="./createPuzzlesPageStyle.css" rel="stylesheet">

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <!--
    To use these fonts in style:
    font-family: 'Montserrat', sans-serif;
    font-family: 'Space Mono', monospace;
  -->

  <!-- Icons -->
  <script src="https://kit.fontawesome.com/fc3f8d6bba.js" crossorigin="anonymous"></script>

  <script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "ocv2xbx6pz");
  </script>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-G06DV4YV0P"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-G06DV4YV0P');
  </script>
</head>
<body>
  
  <div id="master-container">
    
    
    <div >
      <h1>Criação de Python Parsons Puzzles</h1>
      <p>Preencha o formulário abaixo para criar um novo Parson Puzzle.</p>    
      <form
        id="puzzle-form"
      >
        <div class="row" >
          <div class="col-2">
            <label for="dificuldade">Dificuldade:</label><br>
            <select id="dificuldade" name="dificuldade" required>
              <option value="0">Muito fácil</option>
              <option value="1">Fácil</option>
              <option value="2">Médio</option>
              <option value="3">Difícil</option>
              <option value="4">Muito difícil</option>
            </select><br><br>
          </div>
          <div class="col-3">
            <label for="area">Área do exercício:</label><br>
            <select name="area" id="area" required>
              <option value="inputOutput">Entrada e saída</option>
              <option value="condicional">Condicional</option>
              <option value="lacos">Laços de repetição</option>
              <option value="string">Manipulação de strings</option>
              <option value="funcao">Funções</option>
              <option value="arquivo">Manipulação de arquivos</option>
              <option value="vetor">Manipulação de Vetores</option>
              <option value="ordenacao">Ordenação</option>
              <option value="busca">Busca</option>
              <option value="dicionario">Manipulação de Dicionários</option>
              <option value="matriz">Manipulação de Matrizes</option>
              <option value="recursao">Recursão</option>
            </select>
          </div>
          <div class="col-5 tag-container">
            <label for="tags">Adicione tags:</label><br>
            <input id="tags" name="tags">
          </div>
        </div>
        <div class="row" style="margin-top: 10px;">
          <div class="col-4" id="enunciado-col">
            <div id="labelEnunciado">
              <label for="enunciado">Enunciado:</label><br>
            </div>
            <!-- Toolbar personalizada com um id -->
            <div id="enunciado-toolbar">
              <span class="ql-formats">
                <select class="ql-header">
                  <option selected></option>
                  <option value="1"></option>
                  <option value="2"></option>
                  <option value="3"></option>
                </select>
              </span>
              
              <span class="ql-formats">
                <button class="ql-bold"></button>
                <button class="ql-italic"></button>
                <button class="ql-underline"></button>
              </span>
              
              <span class="ql-formats">
                <button class="ql-list" value="ordered"></button>
                <button class="ql-list" value="bullet"></button>
              </span>

              <span class="ql-formats">
                <button class="ql-code-block"></button>
                <button class="ql-code"></button>
              </span>
            </div>
            <div id="quillEnunciado" ></div>
            <!-- Campo oculto para enviar o conteúdo do Quill -->
            <input type="hidden" id="enunciado" name="enunciado">
          </div>
      
          <div class="col-8" id="exercicio-col">
            <div id="labelExercicio">
              <label for="exercicio">Exercício:
                <button type="button" class="btn btn-secondary tooltip-btn" data-bs-toggle="tooltip" data-bs-placement="right" data-bs-title="Cada linha será um dos blocos arrastáveis, a ordem escrita será a ordem correta e para usar identação basta um espaço">
                  ?
                </button>
              </label>
            </div>
            <div id="quillExercicio"></div>
          </div>
        </div>

        
        <div class="row">
          <div class="col-2">
            <button class="button" id="btnTeste" type="button" data-bs-toggle="collapse" data-bs-target="#opcionais" aria-expanded="false" aria-controls="opcionais">Opcionais</button>
          </div>
          <div class="col-2">
            <button class="button" id="btnSubmit" type="submit">Submit</button>
          </div>
        </div>
        
        <!-- Div colapsável -->
        <div class="collapse" id="opcionais">
          <label for="max_wrong_lines">Máximo de Linhas Erradas:</label><br>
          <input type="number" min="0" id="max_wrong_lines" name="max_wrong_lines"><br><br>
          
          
          <!-- Campo de upload de imagem -->
          <label for="imageInput">Escolha uma imagem:</label>
          <input type="file" id="imageInput" accept="image/*"><br><br>
          
          <!-- Outros campos -->
          <label for="python_tutor">Link do Python Tutor:</label>
          <a class="link" href="https://pythontutor.com/render.html#mode=edit" target="_blank">Gere Link Permanente</a>
          <textarea name="python_tutor" id="python_tutor" placeholder="Acesse o website, escreva seu código, clique em 'Generate permanente link', por fim coloque o link aqui" rows="4" cols="50"></textarea><br><br>
          
          <label for="trinketHTML">Trinket HTML</label>
          <a class="link" href="https://trinket.io/library/trinkets/create?lang=python" target="_blank" rel="noopener noreferrer">Gere seu TRinket HTML</a>
          <textarea id="trinketHTML" name="trinketHTML" rows="4" cols="50"></textarea><br><br>
        
          <label for="unittests">Unit Tests (em JSON):</label><br>
          <textarea id="unittests" name="unittests" rows="4" cols="50"></textarea><br><br>
        
          <label for="initcode">Código Inicial:</label><br>
          <textarea id="initcode" name="initcode" rows="4" cols="50"></textarea><br><br>
        
          <label for="code">Código:</label><br>
          <textarea id="code" name="code" rows="4" cols="50"></textarea><br><br>
        
          <label for="toggleTypeHandlers">Toggle Type Handlers (em JSON):</label><br>
          <textarea id="toggleTypeHandlers" name="toggleTypeHandlers" rows="4" cols="50"></textarea><br><br>
        
          <label for="vartests">Var Tests (em JSON):</label><br>
          <textarea id="vartests" name="vartests" rows="4" cols="50"></textarea><br><br>
        </div>

        
      </form>
        
    </div>
    
    <div id="preview" class="row">
      <div id="enunciado-area" class="col-4">
        <div >
          <h1>Enunciado:</h1>
          <span id="enunciado-text">
          </span>
        </div>
      </div>
  
      <div id="code-area" class="col-8">
        <div class="buttons-notch">
          <div class="buttons">
            <button class="button" id="btnReset">Shuffle</button>
            <button class="button" id="btnTestYourself" hidden>
              <img src="./assets/trinket-logo.png" height="15px">
              Teste
            </button>
            <button class="button" id="btnRun">Run</button>
              
          </div>
        </div>
        <div class="code-code-area">
          <div id="msg-carregando" style="display: none;">
            <span class="loader-carregando"></span>
            <span class="icon-text">Carregando...</span>
          </div>
          <div id="sortableTrash" class="sortable-code"></div>
          <div id="sortable" class="sortable-code"></div>
        </div>
      </div>
    </div>
    <div class="row" id="feedback-row">
      <div class="col-4" id="useless">
        <!-- Div onde a imagem será exibida -->
        <div id="imagePreview">
        </div>
      </div>

      <div class="col-8" id="feedback-area">
        <div class="block-margin">
          <div class="feedback-title-area">
            <h1 id="feedBackTitle">Feedback:</h1>
          </div>

          <div class="feedback-feedback-area">
            <span id="feedbackText">
            </span>
          </div>
        </div>
      </div>
    </div>

      
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>

</body>



<script src="./lib/jquery.min.js"></script>
<script src="./lib/jquery-ui.min.js"></script>
<script src="./lib/jquery.ui.touch-punch.min.js"></script>
<script src="./lib/underscore-min.js"></script>
<script src="./lib/lis.js"></script>
<script src="./parsons.js"></script>
<script src="./lib/prettify.js"></script>
<script src="../lib/skulpt.js"></script>
<script src="../lib/skulpt-stdlib.js"></script>
<script src="https://accounts.google.com/gsi/client" async></script>
<script src="https://unpkg.com/jwt-decode/build/cjs/index.js"></script>
<script src="./utils.js"></script>
<!-- Tagify JS -->
<script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify"></script>
<script src="tagify.js"></script>
<script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>
<script>
  /*
  const userData = getCookie("userData");
  const auth = getCookie("auth");

  if (userData === null || auth === null) {
    accessDenied_returningToMain();
  }
    */


  var parson;
  // Função para retornar null caso o campo esteja vazio
  function optionalFieldValue(field) {
      return field.value === ""  ?"null" : field.value;
  }
    
  function optionalFieldValueMaxWrongLines(field) {
    // pega o valor do exercicio a partir do quill.js
    var valorExercicio = returnExercicio();
    return field.value === "" ? countSubstring(valorExercicio, "#distractor") : field.value;
  }

  function fieldImage(imageInput){
    if (imageInput.files.length > 0) {
      return imageInput.files[0];
    }
    return "null"
  }

  function newPuzzle() {

    event.preventDefault(); // Evita o comportamento padrão do formulário

    var enunciado = document.getElementById('enunciado-text').innerHTML;
    var dificuldade = document.getElementById('dificuldade').value;
    var exercicio = returnExercicio();
    var area = document.getElementById('area').value;

    
    // Campos opcionais usando a função optionalFieldValue
    var trinketHTML = optionalFieldValue(document.getElementById('trinketHTML'));
    var pythonTutor = optionalFieldValue(document.getElementById('python_tutor'));

    var imageInput = fieldImage(document.getElementById('imageInput'));

    var max_wrong_lines = optionalFieldValueMaxWrongLines(document.getElementById('max_wrong_lines'));
    var unittests = optionalFieldValue(document.getElementById('unittests'));
    var initcode = optionalFieldValue(document.getElementById('initcode'));
    var code = optionalFieldValue(document.getElementById('code'));
    var toggleTypeHandlers = optionalFieldValue(document.getElementById('toggleTypeHandlers'));
    var vartests = optionalFieldValue(document.getElementById('vartests'));

    var tags = tagsString();

   // var auth = document.getElementById('auth').value;

    var postData = {
      "actionRequest": "postExercicio",
      "payload": {
        "enunciado" : enunciado,
        "dificuldade" : dificuldade,
        "exercicio" : exercicio,
        "max_wrong_lines": max_wrong_lines,
        "unittests": unittests,
        "initcode": initcode,
        "code": code,
        "toggleTypeHandlers": toggleTypeHandlers,
        "vartests": vartests,
        "trinketHTML": trinketHTML,
        "area" : area,
        "pythonTutor" : pythonTutor,
        "imgEnunciado" : imageInput,
        "tags" : tags
      },
      //"auth": auth
    }

    console.log(postData);

    try{
      fetch("https://script.google.com/macros/s/AKfycbyPA-UzG-PVuzKK_d99wr5FS_58xsLv5yDXfIapObnJ6RD-By4EcwlX8FjUo_1sdBPp1w" + "/exec", 
      {
        method: "POST",
        headers: {
          "Content-Type": "text/plain;charset=utf-8",
        },
        // redirect:"manual",
        body: JSON.stringify(postData), // body data type must match "Content-Type" header
      })
      .then(response => {
        return response.json();
      })
      .then(res => {
        console.log(res);
        if (res.status === "success") {
          window.alert("Exercício salvo com sucesso!");
        } 
        else {
          window.alert("Algo deu errado :/\nRecarregue a página.");
        }
      });

      }
      catch (error) {
        window.alert("CATCH! Algo deu errado :"+ error );
      }
  };

  function displayFeedback(fb) {
    console.log("displayFeedback : " + fb);
    function exercicioCorreto() {
      $("#feedbackText").html("Parabéns, você acertou!");
    }

    if (Array.isArray(fb)) {
      if (fb.length > 0) {
        $("#feedbackText").html(fb[0]);
      } 
      else {
        exercicioCorreto();
      }
    } 
    else if (fb.hasOwnProperty("feedback")) {
      if (fb.success) {
        exercicioCorreto();
      }
      else {
        $("#feedbackText").html(fb.feedback);
      }
    } 
    else {
      if (fb.success) {
        exercicioCorreto();
      }
    }
  }

  function atualizarSorteableTrash(){
    // pega o valor do exercicio a partir do quill.js
    var exercicio = returnExercicio();

    var dificuldade = document.getElementById('dificuldade').value;
    //var exercicio = document.getElementById('exercicio').value;
    var trinketHTML = document.getElementById('trinketHTML').value;
    
    // Campos opcionais usando a função optionalFieldValue
    var max_wrong_lines = optionalFieldValueMaxWrongLines(document.getElementById('max_wrong_lines'));
    var unittests = optionalFieldValue(document.getElementById('unittests'));
    var initcode = optionalFieldValue(document.getElementById('initcode'));
    var code = optionalFieldValue(document.getElementById('code'));
    var toggleTypeHandlers = optionalFieldValue(document.getElementById('toggleTypeHandlers'));
    var vartests = optionalFieldValue(document.getElementById('vartests'));
    
    parson = new ParsonsWidget({
      'sortableId': 'sortable',
      'trashId': 'sortableTrash',
      'max_wrong_lines': max_wrong_lines,
      'lang': 'ptbr',
      'initcode': isNullString(initcode),
      'toggleTypeHandlers': isNullString(toggleTypeHandlers),
      'unittests': isNullString(unittests),
      'vartests': isNullString(vartests)
    });
    parson.init(exercicio);
    parson.shuffleLines();
  }

  max_wrong_lines.addEventListener('input', atualizarSorteableTrash);

  var btnRun = document.getElementById('btnRun');
  btnRun.addEventListener('click', function() {
    var fb = parson.getFeedback();
    displayFeedback(fb);
  });
  var btnReset = document.getElementById('btnReset');
  btnReset.addEventListener('click', function() {
    parson.shuffleLines();
    $("#feedbackText").html("");
  });
      
</script>


<script>
  // para fazer o tooltip funcionar
  const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
  const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
</script>

<script>
  document.getElementById('imageInput').addEventListener('change', function(event) {
    const imagePreview = document.getElementById('imagePreview');
    const file = event.target.files[0];
  
    if (file) {
      const reader = new FileReader();
  
      // Quando a imagem é carregada, exibe-a na div
      reader.onload = function(e) {
        imagePreview.innerHTML = ''; // Limpa qualquer conteúdo anterior
        const img = document.createElement('img');
        img.src = e.target.result;
        img.style.maxWidth = '80%'; // Ajusta a imagem ao tamanho da div
        img.style.maxHeight = '80%';
        imagePreview.appendChild(img); // Adiciona a imagem à div
      };
  
      reader.readAsDataURL(file); // Converte o arquivo de imagem para URL
    } else {
      imagePreview.innerHTML = '<span>Imagem não selecionada</span>'; // Exibe uma mensagem se nenhuma imagem for selecionada
    }
  });
</script>

<script src="quiil.js"></script>


</html>